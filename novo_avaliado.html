<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="CSS/nova_avaliacao.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <title>Criar Nova Avaliação</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    rel="stylesheet">

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>
</head>

<body>
  <!--Navbar do avaliado, exclusiva desta página pois o título da página é único-->
  <nav class="navbar navbar-expand-lg navbar-light p-0 m-0">
    <div class="container-fluid p-0">
      <a class="navbar-brand" href="menu.html">
        <h2 class="header-novo-avaliado m-2 ps-1" style="color:aliceblue">Novo Avaliado
        </h2>
      </a>
      <!--logout-->
      <div class="dropdown ms-auto">
        <a href="#" class="d-flex align-items-center text-decoration-none" id="profileDropdown"
          data-bs-toggle="dropdown" aria-expanded="false">
          <img src="ImagensMenu/perfil.png" alt="Logo" width="50" height="50" class="d-flex align-text-top"
            style="margin-right: 30px;">

        </a>
        <ul class="dropdown-menu" aria-labelledby="profileDropdown">
          <li><a class="dropdown-item" href="#" id="logout">Sair</a></li>
        </ul>
      </div>
    </div>
    </div>
  </nav>

  <!--Card para criar novo avaliado-->
  <div class="container mt-5">
    <div class="card shadow mx-auto" style="max-width: 600px;">
      <div class="card-body">
        <h5 class="text-center text-title mb-4" id="titulo-card">Criar Novo Avaliado</h5>

        <div class="text-center mb-4">
          <img src="ImagensMenu/icon1.png" alt="Usuario" class="user-image mb-1" width="120px">
        </div>

        <form id="formAvaliacao">

          <div class="mb-3">
            <label for="nome" class="form-label">Nome completo:</label>
            <input type="text" class="form-control" id="nome" name="nome" value="" placeholder="Digite o nome completo"
              required>
          </div>

          <div class="mb-3">
            <label for="cpf" class="form-label control-label">CPF:</label>
            <input type="text" class="form-control" id="cpf" name="cpf" value="" maxlength="14"
              placeholder="000.000.000-00" required>
          </div>

          <div class="mb-3">
            <label for="genero" class="form-label">Gênero:</label>
            <select class="form-select" id="genero" id="genero" name="genero" value="" required>
              <option value="" selected disabled hidden>Selecione</option>
              <option value="masculino">Masculino</option>
              <option value="feminino">Feminino</option>
              <option value="outro">Outro</option>
              <option value="prefiro-nao-dizer">Prefiro não dizer</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="dataNascimento" class="form-label">Data de Nascimento:</label>
            <div class="d-flex">
              <input type="text" class="form-control" id="dataNascimento" value="" placeholder="DD/MM/AAAA" required>
            </div>
          </div>

          <div class="mb-3">
            <label for="empresa" class="form-label">Empresa:</label>
            <input type="text" class="form-control" id="empresa" name="empresa" value=""
              placeholder="Digite o nome da empresa" required>
          </div>

          <div class="mb-3">
            <label for="gestor" class="form-label">Gestor:</label> <!-- Alterado de setor para gestor -->
            <input type="text" class="form-control" id="gestor" name="gestor" value=""
              placeholder="Digite o nome do gestor responsável" required>
          </div>

          <div class="mb-3">
            <label for="email" class="form-label">Email:</label>
            <input type="email" class="form-control" id="email" name="email" value="" placeholder="exemplo@exemplo.com"
              required>
          </div>

          <div class="d-flex justify-content-between mt-5">
            <a href="nova_avaliacao2.html" class="btn btn-outline-custom btn-voltar">Voltar</a>
            <button type="submit" class="btn btn-primary" id="criar-novo">Criar Avaliado</button>

            <div class="modal" id="modalConfirmacao" tabindex="-1" aria-labelledby="modalConfirmacao"
              aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="titulo-card">Deseja criar o novo avaliado?</h5>
                  </div>
                  <div class="modal-body">
                    Verifique se todas as informações estão corretas antes de criar um novo avaliado. Caso estejam,
                    deseja criar o novo avaliado?
                  </div>
                  <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-custom btn-voltar" data-bs-dismiss="modal">Não</button>
                    <button type="submit" class="btn btn-primary btn btn-primary btn-proximo" id="confirmarEnvio"
                      data-bs-dismiss="modal">Sim</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de Sucesso / Esse modal serve para informar que a competencia foi salva com sucesso -->
          <div class="modal" id="modalSucesso" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="titulo-card">Avaliado criado com sucesso!</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Agora pode adiciona-lo a sua avaliação</p>
                </div>
                <div class="modal-footer d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-custom btn-voltar" data-bs-dismiss="modal"
                    onclick="onclick=window.location = 'nova_avaliacao2.html'">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de erro do servidor / Esse modal serve para informar que houve um problema no servidor para salvar a competencia -->
          <div class="modal" id="modalErro" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="titulo-card">Erro ao tentar salvar o avaliado</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p id="msgModalErro"></p>
                </div>
                <div class="modal-footer d-flex justify-content-end">
                  <button type="button" class="btn btn-outline-custom btn-voltar" data-bs-dismiss="modal">Sair</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="logoutModalLabel">Confirmação de Logout</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  Tem certeza de que deseja sair?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" id="confirmLogout">Sair</button>
                </div>
              </div>
            </div>
          </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.5.3/js/bootstrapValidator.min.js"></script>
<script>

  //Todas as funções de enviar avaliado para o banco, verificação de input de caractéres (como cpf) foram organizadas separadamente para facilitar a manuntenção do código
  //Função que verifica o formulário e chama a função de carregarAvaliado(do banco) para comparar os dados e verificar se podem ser salvos (caso não tenha duplicidade)
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("formAvaliacao");

    if (!form) return;

    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    if (id) carregarAvaliado(id);

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      if (!form.checkValidity()) {
        form.classList.add("was-validated");
        return;
      }

      // Exibe modal de confirmação antes de enviar, exigindo dupla confirmação do usuário
      const usuarioConfirmou = await exibirModalConfirmacao("#modalConfirmacao", "#confirmarEnvio");
      if (!usuarioConfirmou) return;

      // Obtém os dados formatados do formulário
      const data = obterDadosFormulario(form);

      const method = id ? "PUT" : "POST";
      const url = id ? `http://localhost:3000/avaliado/${id}` : "http://localhost:3000/avaliado";

      await enviarDados(url, method, data);
    });
  });

  // Função para carregar dados do avaliado
  async function carregarAvaliado(id) {
    try {
      const response = await fetch(`http://localhost:3000/avaliado/${id}`);
      const data = await response.json();

      if (data) {
        for (const key in data) {
          const input = document.getElementById(key);
          if (input) input.value = data[key];
        }
      }
    } catch (error) {
      console.error("Erro ao carregar dados do avaliado:", error);
    }
  }

  // Função para exibir modal de confirmação e aguardar a resposta do usuário
  function exibirModalConfirmacao(modalId, botaoId) {
    return new Promise((resolve) => {
      const modalElement = document.querySelector(modalId);
      const modalInstance = new bootstrap.Modal(modalElement);
      modalInstance.show();

      const botaoConfirmar = modalElement.querySelector(botaoId);
      if (!botaoConfirmar) {
        console.error("Botão de confirmação não encontrado no modal!");
        resolve(false);
      }

      botaoConfirmar.addEventListener("click", () => {
        modalInstance.hide();
        resolve(true);
      }, { once: true });
    });
  }

  // Função para capturar e formatar os dados do formulário
  function obterDadosFormulario(form) {
    const formData = new FormData(form);
    return {
      nome: formData.get("nome"),
      cpf: formData.get("cpf").replace(/[\.\-]/g, ""),
      genero: formData.get("genero"),
      dataNascimento: formatarDataNascimento(),
      empresa: formData.get("empresa"),
      gestor: formData.get("gestor"),
      email: formData.get("email"),
    };
  }

  // Função para capturar a data corretamente do datepicker e formatá-la para o banco
  function formatarDataNascimento() {
    const dataNascimentoInput = $("#dataNascimento").datepicker("getDate");
    return dataNascimentoInput ? dataNascimentoInput.toISOString().split("T")[0] : "";
  }

  // Função para enviar os dados para o servidor
  async function enviarDados(url, method, data) {
    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json(); // Captura a resposta do servidor

      if (!response.ok) { // Se houver erro (status 400, 500, etc.)
        console.error("Erro no SQL:", result.message); // Exibe a mensagem real do erro no console
        mostrarErroModal(result.message, response.status, response.statusText); // Exibe no modal de erro
        return;
      }

      new bootstrap.Modal(document.getElementById('modalSucesso')).show();

    } catch (error) {
      console.error("Erro ao salvar avaliado:", error);
    }
  }

  // Função para fechar modais ativos antes de abrir novos
  function fecharModaisAbertos() {
    document.querySelectorAll(".modal.show").forEach(modal => {
      const modalInstance = bootstrap.Modal.getInstance(modal);
      if (modalInstance) modalInstance.hide();
    });
  }

  // Função para exibir modal de erro com a mensagem correta
  function mostrarErroModal(message, status, statusText) {
    const msgModalErro = document.getElementById("msgModalErro");
    msgModalErro.innerHTML = `<p>${message} (Erro ${status} ${statusText})</p>`;

    new bootstrap.Modal(document.getElementById("modalErro")).show();
  }

  // Logout
  document.getElementById('logout').addEventListener('click', function () {
    const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
    modal.show();
  });

  document.getElementById('confirmLogout').addEventListener('click', function () {
    window.location.href = 'login.html';
  });

  //script para formatar o cpf conforme o usuário digita
  // Adiciona um evento "input" ao campo de CPF, ou seja, toda vez que o usuário digitar algo, esse código será executado.
  document.getElementById("cpf").addEventListener("input", function (e) {

    // Remove qualquer caractere que não seja número ou a letra "X" (pensando na futura inclusão do CPF com X).
    // Isso impede que o usuário digite letras ou símbolos aleatórios.
    let value = e.target.value.replace(/[^0-9Xx]/g, "").slice(0, 11);

    // Aplica a máscara automaticamente ao CPF, adicionando os pontos e o traço conforme o usuário digita.
    e.target.value = value
      .replace(/^(\w{3})(\w)/, "$1.$2") // Adiciona o primeiro ponto após os 3 primeiros números.
      .replace(/^(\w{3})\.(\w{3})(\w)/, "$1.$2.$3") // Adiciona o segundo ponto após os 6 primeiros números.
      .replace(/^(\w{3})\.(\w{3})\.(\w{3})(\w)/, "$1.$2.$3-$4"); // Adiciona o traço antes dos últimos 2 números.

    // Captura o CPF já formatado com os pontos e o traço.
    let cpfFormatado = e.target.value;

    // Expressão regular para garantir que o CPF siga o formato correto "000.000.000-00"
    let regexCpf = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;

    // Se o CPF digitado não estiver no formato correto, exibe uma mensagem de erro no campo.
    if (!regexCpf.test(cpfFormatado)) {
      e.target.setCustomValidity("CPF inválido! Use o formato correto: 000.000.000-00");
    } else {
      // Se o CPF estiver correto, remove qualquer erro para permitir o envio do formulário.
      e.target.setCustomValidity("");
    }
  });

  //datepicker para informar a idade do avaliado. Foi alterado para data de nascimento, visando aumentar a vida útil da informação salva no banco
  $(document).ready(function () {
    // Configurações do calendário
    //criamos o elemento #datepicker que utilizam o método datepicker() do bootstrap para funcionar
    $('#dataNascimento').datepicker({
      //Formato das datas, conforme o país (neste caso brasileiro)
      format: 'dd/mm/yyyy',
      //autoclose serve para fechá-lo automaticamente ao selecionar uma data
      autoclose: true,
      language: 'pt-BR'
    });
  });





</script>


</html>